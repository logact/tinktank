首先说明消息的传递过程以及消息可能会在哪里丢失。
# 消息的生产消费过程
我们首先来看消息丢失的环节，一条消息从生产到消费完成这个过程，可以划分三个阶段，分别为消息生产阶段，消息存储阶段和消息消费阶段。

![图片](https://mmbiz.qpic.cn/mmbiz_png/PxMzT0Oibf4iaNrtKghAO3x3QUBv7cTm5h7cMbNdKG7kdR50lTpChiag6baDyp7w2lYUXtceteDGajqut95J4ib3qw/640?wx_fmt=png&wxfrom=5&wx_lazy=1&wx_co=1)

1.   消息生产阶段： 从消息被生产出来，然后提交给 MQ 的过程中，只要能正常收到 MQ Broker 的 ack 确认响应，就表示发送成功，所以只要处理好返回值和异常，这个阶段是不会出现消息丢失的。
    
2.  消息存储阶段： 这个阶段一般会直接交给 MQ 消息中间件来保证，但是你要了解它的原理，比如 Broker 会做副本，保证一条消息至少同步两个节点再返回 ack。
    
3.  消息消费阶段： 消费端从 Broker 上拉取消息，只要消费端在收到消息后，不立即发送消费确认给 Broker，而是等到执行完业务逻辑后，再发送消费确认，也能保证消息的不丢失。
# 分布式故障的出现
1. 假设咋消费生产者得到ack后消息中间件挂掉了怎么办？
	1. 首先我们可以使用[[消息队列集群]]来增强这个系统稳定性
# 我们需要一个消息确认机制来弥补
[[可靠消息服务]]


