[[中付金融支付平台.excalidraw.svg]]
[[中付金融支付平台.excalidraw]]
# 清算的过程
1. 用户向`支付网关服务`发起支付交易
	1. `鉴权服务`拦截请求进行API鉴权
	2. 如何拦截？//todo
	3. 拦截了什么？比如用户的支付渠道权限等等？
	4. 这个鉴权服务该如何设计
2. 支付网关调用`商户信息服务`查验商户数据
	1. 查找商户预存储的一些支付信息
2. 支付网关调用风控服务
	1. 风控服务会调用商户信息服务查看用户的风控配置信息
	2. 风控服务使用商户的风控配置信息去调用风控接口查询商户是否要被拦截
3. 如果风控通过调用相对应的支付渠道服务完成支付
4. 支付网关调用清算服务将支付信息打入清算服务中（使用`异步调用`）

# 清算的过程
## 数据流入
1. 从`支付网关服务`用户支付时候的支付订单数据获取账单信息
## 定时清算
### 每日定时统计用户的 账单信息
**一些思考**
- 在什么时候推送如果在全球时间不一致的情况下推送就会出现问题？//todo
- 应该该在对于每个商户推送的不同时间段落来进行核算？//todo `面试亮点`

1. 将用户的账单信息定时统计（按照从`商户信息服务`中获得的用户配置信息）
2. 将统计的结果通过`消息微服务`推送到商户（可以通过邮件，也可以通过反向的API）[[可靠消息服务]]

### 与渠道的清算对账关系
1. `支付渠道服务`通过定时任务推送来自第三方的账单消息数据到消息服务
2.  清算系统定时任务对照用户的账单信息与支付渠道的账单信息
3. 如果出现比对错误那么就把异常的消息推送给管理人员
结算转账是在每个月的结算点通过让财务进行对账转账


